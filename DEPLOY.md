# Инструкция по деплою

## Переменные окружения

### Сервер (.env в папке server)

```env
# MongoDB
MONGODB_URI="your_mongodb_connection_string"

# JWT
JWT_SECRET="your_jwt_secret_key"

# Порт сервера
PORT=3000

# Режим работы
NODE_ENV=production

# URL клиента (для CORS и Socket.IO)
CLIENT_URL=https://your-domain.com

# Telegram Bot (опционально)
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
TELEGRAM_ADMIN_CHAT_ID=your_telegram_chat_id
```

### Клиент

В продакшене клиент автоматически использует относительные пути для всех API запросов и Socket.IO подключений.

## Настройки для деплоя

### 1. API URLs

Все API запросы используют относительные пути (`/api/...`), что позволяет работать как в разработке, так и в продакшене без изменений.

**Файлы:**
- `client/src/utils/config.js` - автоматически определяет продакшен и использует пустую строку для `API_BASE_URL`
- `client/src/services/*.service.js` - все используют относительные пути

### 2. Socket.IO

**Клиент:** `client/src/services/socket.service.js`
- В продакшене автоматически использует `window.location.origin`
- В разработке использует `API_BASE_URL` или `http://127.0.0.1:3000`

**Сервер:** `server/index.js`
- Настроен CORS для продакшена через `CLIENT_URL`
- Поддерживает WebSocket и polling транспорты

### 3. MongoDB

Все сообщения чата сохраняются в MongoDB через модели:
- `Chat` - чаты пользователей
- `Message` - сообщения в чатах

**Модели:** `server/modules/chat/chat.model.js`

### 4. Telegram Bot (опционально)

Для управления чатами через Telegram необходимо:

1. **Создать бота в Telegram:**
   - Напишите [@BotFather](https://t.me/BotFather) в Telegram
   - Отправьте команду `/newbot`
   - Следуйте инструкциям для создания бота
   - Сохраните полученный токен

2. **Получить Chat ID администратора:**
   - Напишите [@userinfobot](https://t.me/userinfobot) в Telegram
   - Скопируйте ваш Chat ID

3. **Добавить переменные в `.env`:**
   ```env
   TELEGRAM_BOT_TOKEN=your_bot_token_from_botfather
   TELEGRAM_ADMIN_CHAT_ID=your_chat_id_from_userinfobot
   ```

4. **Команды бота:**
   - `/start` - Приветствие и список команд
   - `/chats` - Список всех активных чатов
   - `/chats_unread` - Список чатов с непрочитанными сообщениями
   - `/chat <chatId>` - История конкретного чата
   - `/reply <chatId> <сообщение>` - Ответить пользователю
   - `/help` - Справка по командам

5. **Автоматические уведомления:**
   - При получении нового сообщения от пользователя админ получает уведомление в Telegram
   - Ответы из Telegram автоматически отправляются пользователю через веб-интерфейс

**Файлы:**
- `server/modules/telegram/telegram.bot.js` - Основной файл бота
- `server/modules/telegram/telegram.service.js` - Сервис для работы с Telegram

### 5. Статические файлы

В продакшене сервер раздает статические файлы из `client/dist`:
- Все запросы, не начинающиеся с `/api`, перенаправляются на `index.html`
- Это позволяет React Router работать корректно

## Проверка после деплоя

1. **API запросы:** Проверьте, что все API запросы работают (авторизация, загрузка файлов, чат)
2. **Socket.IO:** Убедитесь, что WebSocket подключение устанавливается (проверьте консоль браузера)
3. **Чат:** Проверьте отправку и получение сообщений в реальном времени
4. **MongoDB:** Убедитесь, что сообщения сохраняются в базе данных
5. **Telegram Bot (если настроен):**
   - Отправьте `/start` боту в Telegram
   - Проверьте получение уведомлений о новых сообщениях
   - Проверьте отправку ответов через команду `/reply`
   - Убедитесь, что ответы доставляются пользователям в веб-интерфейсе

## Важные моменты

- Все ссылки автоматически адаптируются для продакшена
- Socket.IO использует текущий домен в продакшене
- MongoDB должна быть доступна из сервера
- CORS настроен для работы с указанным `CLIENT_URL`
- Telegram бот работает только если установлены `TELEGRAM_BOT_TOKEN` и `TELEGRAM_ADMIN_CHAT_ID`
- Все сообщения синхронизируются между веб-интерфейсом и Telegram