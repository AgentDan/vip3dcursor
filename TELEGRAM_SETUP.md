# Инструкция по настройке Telegram бота

## Шаг 1: Создание бота в Telegram

1. Откройте Telegram и найдите [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям:
   - Введите имя бота (например: "Chat Support Bot")
   - Введите username бота (должен заканчиваться на `bot`, например: `my_chat_support_bot`)
4. Сохраните полученный токен (выглядит как: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

## Шаг 2: Получение Chat ID администратора

1. Откройте Telegram и найдите [@userinfobot](https://t.me/userinfobot)
2. Отправьте команду `/start`
3. Бот вернет ваш Chat ID (число, например: `123456789`)
4. Сохраните этот Chat ID

## Шаг 3: Настройка переменных окружения

Добавьте в файл `server/.env`:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_от_botfather
TELEGRAM_ADMIN_CHAT_ID=ваш_chat_id_от_userinfobot
```

**Важно:** 
- Не публикуйте эти значения в открытом доступе
- Добавьте `.env` в `.gitignore` если еще не добавлен

## Шаг 4: Перезапуск сервера

После добавления переменных окружения перезапустите сервер:

```bash
cd server
npm start
```

Вы должны увидеть в консоли:
```
✅ Telegram бот инициализирован
```

Если переменные не установлены, вы увидите предупреждение, но сервер продолжит работать без Telegram бота.

## Шаг 5: Проверка работы

1. Найдите вашего бота в Telegram по username, который вы указали при создании
2. Отправьте команду `/start`
3. Бот должен ответить приветственным сообщением со списком команд

## Доступные команды

### `/start`
Приветствие и список всех доступных команд

### `/help`
Подробная справка по использованию бота

### `/chats`
Показать список всех активных чатов с пользователями

### `/chats_unread`
Показать только чаты с непрочитанными сообщениями

### `/chat <chatId>`
Показать полную историю конкретного чата

**Пример:**
```
/chat 507f1f77bcf86cd799439011
```

### `/reply <chatId> <сообщение>`
Ответить пользователю на его сообщение

**Пример:**
```
/reply 507f1f77bcf86cd799439011 Привет! Как могу помочь?
```

## Автоматические уведомления

Когда пользователь отправляет сообщение через веб-интерфейс:
- Админ автоматически получает уведомление в Telegram
- Уведомление содержит:
  - Имя пользователя
  - Chat ID
  - Текст сообщения
  - Время отправки
  - Инструкцию для ответа

## Как это работает

1. **Пользователь отправляет сообщение** → Сохраняется в MongoDB → Отправляется через Socket.IO админу в веб-интерфейсе → **Уведомление отправляется админу в Telegram**

2. **Админ отвечает через Telegram** → Сообщение сохраняется в MongoDB → Отправляется пользователю через Socket.IO в веб-интерфейсе

3. **Админ отвечает через веб-интерфейс** → Сообщение сохраняется в MongoDB → Отправляется пользователю через Socket.IO

Все сообщения синхронизируются между веб-интерфейсом и Telegram через MongoDB.

## Безопасность

- Только пользователь с указанным `TELEGRAM_ADMIN_CHAT_ID` может использовать бота
- Все остальные пользователи получат сообщение об отсутствии доступа
- Токен бота хранится в `.env` и не должен попадать в публичные репозитории

## Устранение неполадок

### Бот не отвечает
- Проверьте, что `TELEGRAM_BOT_TOKEN` правильный
- Убедитесь, что сервер запущен и бот инициализирован
- Проверьте логи сервера на наличие ошибок

### Не получаю уведомления
- Проверьте, что `TELEGRAM_ADMIN_CHAT_ID` правильный
- Убедитесь, что пользователь действительно отправляет сообщения
- Проверьте, что MongoDB подключена и сообщения сохраняются

### Ошибка "Authentication error"
- Проверьте правильность токена бота
- Убедитесь, что бот не был удален или заблокирован

### Команды не работают
- Убедитесь, что вы используете правильный Chat ID
- Проверьте формат команд (пробелы, регистр)
- Посмотрите логи сервера для деталей ошибок
